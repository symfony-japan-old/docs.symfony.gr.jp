
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>セキュリティ | Symfony2日本語ドキュメント</title>
    <link rel="stylesheet" href="../static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../static/configurationblock.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
      <script type="text/javascript" src="../static/js/jquery.corner.js"></script>
      <script type="text/javascript" src="../static/configurationblock.js"></script>
      <script type="text/javascript">
      $(function(){
          $('.section h1').corner();
          $('.highlight-python pre').corner();
          $('.highlight-yml pre').corner();
          $('.highlight').corner();
      });
      </script>
    <link rel="top" title="Symfony2Doc 1.0.0 documentation" href="../index.html" />
    <link rel="up" title="ガイドブック" href="index.html" />
    <link rel="next" title="HTTP キャッシュ" href="http_cache.html" />
    <link rel="prev" title="フォーム" href="forms.html" /> 
  </head>
  <body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1&appId=47270766548";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div id="all">
  <div id="content">
    <div id="content_wrapper">
      <div id="top_menu">
        <div id="top_menu_wrapper">
        </div>
      </div>
      <div id="header_top">
        <h1 id="logo_top"><a href="http://docs.symfony.gr.jp/">Symfonyユーザー会ドキュメントポータル</a></h1>
        <div id="header_top_left"></div>
      </div>
      <!-- end #header -->
      <div id="navbar">
        <ul>
          <li><a href="../index.html">トップ（索引）</a></li>
          <li><a href="../quick_tour/index.html">クイックツアー</a></li>
          <li><a href="index.html">ガイドブック</a></li>
          <li><a href="../cookbook/index.html">クックブック</a></li>
          <li><a href="../components/index.html">コンポーネント</a></li>
          <li><a href="../reference/index.html">リファレンス</a></li>
          <li><a href="../contributing/index.html">貢献</a></li>
        </ul>
      </div>
      <!-- end #navbar -->
      <div id="main">  
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3>このページのコンテンツ</h3>
  <ul>
<li><a class="reference internal" href="#">セキュリティ</a><ul>
<li><a class="reference internal" href="#http">基本的なサンプル: HTTP 認証</a></li>
<li><a class="reference internal" href="#id2">セキュリティ機能の仕組み: 認証と承認</a><ul>
<li><a class="reference internal" href="#id3">ファイアーウォール (認証)</a></li>
<li><a class="reference internal" href="#id4">アクセス制御 (承認)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#book-security-form-login">従来のログインフォームの使用</a></li>
<li><a class="reference internal" href="#id6">承認</a><ul>
<li><a class="reference internal" href="#url">特定の URL パターンをセキュアにする</a></li>
<li><a class="reference internal" href="#ip">IP によるセキュア化</a></li>
<li><a class="reference internal" href="#book-security-securing-channel">チャンネルによるセキュア化</a></li>
<li><a class="reference internal" href="#book-security-securing-controller">コントローラをセキュアにする</a></li>
<li><a class="reference internal" href="#id9">他のサービスをセキュアにする</a></li>
<li><a class="reference internal" href="#acls">アクセス制御リスト (ACLs): 個々のデータベースオブジェクトをセキュアにする</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id10">ユーザ</a><ul>
<li><a class="reference internal" href="#id11">ユーザはどこから来た？ (<em>ユーザプロバイダ</em>)</a><ul>
<li><a class="reference internal" href="#id12">コンフィギュレーションファイルでユーザを特定する</a></li>
<li><a class="reference internal" href="#book-security-user-entity">データベースからユーザをロードする</a></li>
</ul>
</li>
<li><a class="reference internal" href="#book-security-encoding-user-password">ユーザパスワードのエンコーディング</a></li>
<li><a class="reference internal" href="#user">User オブジェクトの読み出し</a></li>
<li><a class="reference internal" href="#id15">複数のユーザプロバイダの使用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id16">権限</a><ul>
<li><a class="reference internal" href="#id17">階層的な権限</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18">ログアウト</a></li>
<li><a class="reference internal" href="#book-security-template">テンプレートにおけるアクセス制御</a></li>
<li><a class="reference internal" href="#id20">コントローラにおけるアクセス制御</a></li>
<li><a class="reference internal" href="#id21">他のユーザになりすます</a></li>
<li><a class="reference internal" href="#id22">ステートレス認証</a></li>
<li><a class="reference internal" href="#id23">最後に</a></li>
<li><a class="reference internal" href="#id24">クックブック でもっと学ぶ</a></li>
</ul>
</li>
</ul>

  <h4>前のドキュメント</h4>
  <p class="topless"><a href="forms.html"
                        title="previous chapter">フォーム</a></p>
  <h4>次のドキュメント</h4>
  <p class="topless"><a href="http_cache.html"
                        title="next chapter">HTTP キャッシュ</a></p>
  <h3>ソース</h3>
  <ul class="this-page-menu">
    <li><a href="../sources/book/security.txt"
           rel="nofollow">ページのソースを表示</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>クイック検索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
          <br />
          <br />
          <div id="other">
            <h3>クイックリンク</h3>
            <ul>
              <li><a href="installation.html">インストール方法</a></li>
              <li><a href="../reference/forms/types.html">FormTypeリファレンス</a></li>
              <li><a href="../reference/constraints.html">バリデータリファレンス</a></li>
              <li><a href="http://twig.sensiolabs.org/documentation">Twigリファレンス</a></li>
              <li><a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/annotations-reference.html">Doctrine ORMアノテーションリファレンス</a></li>
            </ul>

<br />
            <h3>コメントリスト</h3>

<script type="text/javascript" src="http://symfony-japan.disqus.com/combination_widget.js?num_items=10&hide_mods=0&color=grey&default_tab=recent&excerpt_length=200"></script><a href="http://disqus.com/">Powered by Disqus</a>


            <br />
            <p>ご質問や翻訳不備等お気軽にコメントください。</p>

            <br />
          </div>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            

<p>コンテンツ上部に更新日の記載のないページは、翻訳の内容が2.0相当のものになっております。最新の内容は<a href="http://symfony.com/doc/current/book/security.html">原文のページ</a>をご確認ください。</p>

  <div class="section" id="index-0">
<span id="id1"></span><h1>セキュリティ<a class="headerlink" href="#index-0" title="Permalink to this headline">¶</a></h1>
<p>セキュリティは、特定のリソースに対するアクセス権限を持たないユーザからのアクセスを制御するために、２つのステップを行います。</p>
<p>まず第一のステップは、セキュリティシステムが、ユーザ認証で送られてくる情報から、そのユーザが誰かを識別することです。この処理は<strong>認証</strong>と呼ばれ、そのユーザが誰であるかを探そうとします。</p>
<p>そしてユーザを特定した後に、第二のステップとして、アクセスしようとしているリソースに対して、そのユーザがアクセス可能かどうかを判断します。この処理は<strong>承認</strong>と呼ばれ、そのユーザがある特定のアクションを行うことのできる権限を保持しているかどうかをチェックします。</p>
<img alt="../images/security_authentication_authorization.png" class="align-center" src="../images/security_authentication_authorization.png" />
<p>もっとも良い学習方法はサンプルを見ることですので、早速始めましょう。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Symfony の <a class="reference external" href="https://github.com/symfony/Security">Security コンポーネント</a> は、スタンドアロンの PHP ライブラリとして使用できます。</p>
</div>
<div class="section" id="http">
<h2>基本的なサンプル: HTTP 認証<a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h2>
<p>セキュリティコンポーネントは、アプリケーションのコンフィギュレーションで設定できます。実際、最も標準的なセキュリティのセットアップは、正しいコンフィギュレーションを使用することです。以下の設定では <tt class="docutils literal"><span class="pre">/admin/*</span></tt> にマッチする全ての URL をセキュアにするよう Symfony に設定しています。そして、HTTP ベーシック認証 (古風なユーザ名/パスワードの入力ボックス) を使用してユーザに証明書を尋ねています:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">secured_area</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>    <span class="l-Scalar-Plain">^/</span>
            <span class="l-Scalar-Plain">anonymous</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
            <span class="l-Scalar-Plain">http_basic</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">realm</span><span class="p-Indicator">:</span> <span class="s">&quot;Secured</span><span class="nv"> </span><span class="s">Demo</span><span class="nv"> </span><span class="s">Area&quot;</span>

    <span class="l-Scalar-Plain">access_control</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">path</span><span class="p-Indicator">:</span> <span class="nv">^/admin</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="nv">ROLE_ADMIN</span> <span class="p-Indicator">}</span>

    <span class="l-Scalar-Plain">providers</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">in_memory</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">users</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">ryan</span><span class="p-Indicator">:</span>  <span class="p-Indicator">{</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">ryanpass</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="s">&#39;ROLE_USER&#39;</span> <span class="p-Indicator">}</span>
                <span class="l-Scalar-Plain">admin</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">kitten</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="s">&#39;ROLE_ADMIN&#39;</span> <span class="p-Indicator">}</span>

    <span class="l-Scalar-Plain">encoders</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">Symfony\Component\Security\Core\User\User</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">plaintext</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/security.xml --&gt;</span>
<span class="nt">&lt;srv:container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/security&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:srv=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;config&gt;</span>
        <span class="nt">&lt;firewall</span> <span class="na">name=</span><span class="s">&quot;secured_area&quot;</span> <span class="na">pattern=</span><span class="s">&quot;^/&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;anonymous</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;http-basic</span> <span class="na">realm=</span><span class="s">&quot;Secured Demo Area&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/firewall&gt;</span>

        <span class="nt">&lt;access-control&gt;</span>
            <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/admin&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_ADMIN&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/access-control&gt;</span>

        <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">&quot;in_memory&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;ryan&quot;</span> <span class="na">password=</span><span class="s">&quot;ryanpass&quot;</span> <span class="na">roles=</span><span class="s">&quot;ROLE_USER&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;admin&quot;</span> <span class="na">password=</span><span class="s">&quot;kitten&quot;</span> <span class="na">roles=</span><span class="s">&quot;ROLE_ADMIN&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/provider&gt;</span>

        <span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">&quot;Symfony\Component\Security\Core\User\User&quot;</span> <span class="na">algorithm=</span><span class="s">&quot;plaintext&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/config&gt;</span>
<span class="nt">&lt;/srv:container&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;secured_area&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;pattern&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/&#39;</span><span class="p">,</span>
            <span class="s1">&#39;anonymous&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
            <span class="s1">&#39;http_basic&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;realm&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Secured Demo Area&#39;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/admin&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;in_memory&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;ryan&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ryanpass&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_USER&#39;</span><span class="p">),</span>
                <span class="s1">&#39;admin&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;kitten&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="s1">&#39;encoders&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;Symfony\Component\Security\Core\User\User&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;plaintext&#39;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Symfony のスタンダードディストリビューションでは、セキュリティコンフィギュレーションは、別ファイルに分けてあります(例えば、<tt class="docutils literal"><span class="pre">app/config/security.yml</span></tt> など)。別ファイルに分けない際には、メインの設定ファイル(例えば、<tt class="docutils literal"><span class="pre">app/config/config.yml</span></tt>)に直接書くこともできます。</p>
</div>
<p>この設定の結果、以下のようなセキュリティシステムになりました:</p>
<ul class="simple">
<li>このシステムには２人のユーザがいます(<tt class="docutils literal"><span class="pre">ryan</span></tt> と <tt class="docutils literal"><span class="pre">admin</span></tt>)。</li>
<li>HTTP ベーシック認証によってユーザ認証を行います。</li>
<li><tt class="docutils literal"><span class="pre">/admin/*</span></tt> にマッチする全ての URL がセキュアになり、そのURLには <tt class="docutils literal"><span class="pre">admin</span></tt> ユーザのみアクセス可能です。</li>
<li><tt class="docutils literal"><span class="pre">/admin/*</span></tt> にマッチしない全ての URL には、認証が無く、アクセス制限はありません。</li>
</ul>
<p>セキュリティ機能がどのようになっているか、そして、設定の各部分がどう作用しているか、簡単に見てみましょう。</p>
</div>
<div class="section" id="id2">
<h2>セキュリティ機能の仕組み: 認証と承認<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Symfony のセキュリティシステムは認証によってユーザの特定を行います。そして、次にそのユーザが特定のリソースや URL にアクセス可能かどうかをチェックします。</p>
<div class="section" id="id3">
<h3>ファイアーウォール (認証)<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>ユーザからファイアーウォールによって保護されている URL にリクエストがあった際に、セキュリティシステムは作動します。ファイアーウォールは、ユーザ認証が必要かどうかを判断し、必要であれば、同ユーザにレスポンスを返し、認証のプロセスを開始します。</p>
<p>ファイアーウォールは、受け取るリクエストの URL が、設定された正規表現 <tt class="docutils literal"><span class="pre">pattern</span></tt> の値にマッチした際に作動します。この例では、<em>全ての</em>受け取るリクエストは <tt class="docutils literal"><span class="pre">pattern</span></tt> (<tt class="docutils literal"><span class="pre">^/</span></tt>) にマッチします。ファイアーウォールが作動しているからといっても、全ての URL に対してユーザ名とパスワードの入力ボックスによる HTTP 認証が<em>表示されるわけではありません</em>。例えば、全てのユーザは <tt class="docutils literal"><span class="pre">/foo</span></tt> に認証のプロンプト無しにアクセスできます。</p>
<img alt="../images/security_anonymous_user_access.png" class="align-center" src="../images/security_anonymous_user_access.png" />
<p>このファイアーウォールは、<tt class="docutils literal"><span class="pre">anonymous</span></tt> 設定パラメータによって<em>匿名ユーザ</em>を許可しているからです。つまり、このファイアーウォールは完全な認証を必要としていません。<tt class="docutils literal"><span class="pre">foo</span></tt> にアクセスするための特別な<tt class="docutils literal"><span class="pre">権限</span></tt>は存在しないので、ユーザ認証無しに、このリクエストを行うことができます。</p>
<p><tt class="docutils literal"><span class="pre">anonymous</span></tt> キーを削除してしまうと、このファイアーウォールは<em>毎回</em>ユーザの認証を行うようになります。</p>
</div>
<div class="section" id="id4">
<h3>アクセス制御 (承認)<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>しかし、ユーザが <tt class="docutils literal"><span class="pre">/admin/foo</span></tt> にリクエストする際には処理は異なります。<tt class="docutils literal"><span class="pre">access_control</span></tt> 設定のセクションにより、正規表現のパターン <tt class="docutils literal"><span class="pre">^/admin</span></tt> (<tt class="docutils literal"><span class="pre">/admin</span></tt> や <tt class="docutils literal"><span class="pre">/admin/*</span></tt> にマッチする全て)にマッチする全ての URL に <tt class="docutils literal"><span class="pre">ROLE_ADMIN</span></tt> 権限を必要としているからです。権限はほとんどの承認の基礎となります。<tt class="docutils literal"><span class="pre">ROLE_ADMIN</span></tt> 権限を持つユーザのみが <tt class="docutils literal"><span class="pre">/admin/foo</span></tt> にアクセスが可能です。</p>
<img alt="../images/security_anonymous_user_denied_authorization.png" class="align-center" src="../images/security_anonymous_user_denied_authorization.png" />
<p>前のケースと同じように、ユーザが最初にリクエストを投げても、このファイアーウォールはユーザ識別を行いません。しかし、アクセス制御のレイヤーがユーザのアクセスを拒否する(匿名ユーザは <tt class="docutils literal"><span class="pre">ROLE_ADMIN</span></tt> 権限がありません)とすぐに、ファイアーウォールは認証処理を開始します。認証処理は、あなたの使用する認証メカニズム次第です。例えば、フォームログイン認証を使用する際には、ユーザはログインページへリダイレクトされます。また、HTTP 認証を使用する際にはユーザに HTTP 401 のレンスポンスを返し、ユーザ名とパスワードの入力ボックスを表示します。</p>
<p>そしてユーザは HTTP 認証を求めるアプリケーションに対し証明書を送信します。証明書が有効であれば、最初に送ったリクエストを再び試みることができます。</p>
<img alt="../images/security_ryan_no_role_admin_access.png" class="align-center" src="../images/security_ryan_no_role_admin_access.png" />
<p>この例では、ユーザ <tt class="docutils literal"><span class="pre">ryan</span></tt> はこのファイアーウォールにおいて認証に成功します。しかし、<tt class="docutils literal"><span class="pre">ryan</span></tt> は <tt class="docutils literal"><span class="pre">ROLE_ADMIN</span></tt> の権限がないため、<tt class="docutils literal"><span class="pre">/admin/foo</span></tt> にアクセスすると拒否されます。結局、このユーザはアクセスが拒否されたというメッセージを見ることになります。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Symfony がユーザのアクセスを拒否すると、そのユーザにはエラー画面を表示し、 HTTP の403ステータスコード(<tt class="docutils literal"><span class="pre">Forbidden</span></tt>) を送ります。アクセス拒否のエラー画面は、クックブック <a class="reference internal" href="../cookbook/controller/error_pages.html#cookbook-error-pages-by-status-code"><em>Error Pages</em></a> の403エラーページのカスタマイズを参考に、カスタマイズすることができます。</p>
</div>
<p>そして <tt class="docutils literal"><span class="pre">admin</span></tt> ユーザが <tt class="docutils literal"><span class="pre">admin/foo</span></tt> にリクエストをした際に、同じ処理が行われます。しかし、認証されているので、アクセス制御のレイヤーはそのリクエストを通すことになります:</p>
<img alt="../images/security_admin_role_access.png" class="align-center" src="../images/security_admin_role_access.png" />
<p>あるユーザが保護されているリソースにリクエストをする際のフローは分かりやすく、また、とても柔軟です。後で見ることになりますが、認証はフォームログイン、X.509 認証、Twitter 認証など、いろいろな方法で操作することが可能です。認証方法に関係なく、リクエストフローはすべて同じなのです:</p>
<ol class="arabic simple">
<li>ユーザが保護されたリソースにアクセスする。</li>
<li>アプリケーションがユーザをログインフォームへリダイレクトする。</li>
<li>ユーザがユーザ名とパスワードなどの証明書を送信する。</li>
<li>ファイアーウォールがユーザを認証する。</li>
<li>認証されたユーザは最初に送ったリクエストを再度試みる。</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>厳密には、ユーザ認証時の処理は、使用する認証メカニズムによって多少異なります。例えば、フォームログインを使用する際には、ユーザはフォームを処理する URL (<tt class="docutils literal"><span class="pre">/login_check</span></tt>)に、証明書を送信します。そして、最初に送ったリクエストの URL (<tt class="docutils literal"><span class="pre">/admin/foo</span></tt>)にリダイレクトされます。しかし、HTTP 認証の際には、ユーザは同じ URL (<tt class="docutils literal"><span class="pre">/admin/foo</span></tt>)に直接証明書を送信することになります。そして、同じリクエストの結果ページをリダイレクト無しにユーザに返します。</p>
<p class="last">こういった違いは、問題となることはないはずですが、覚えておくと良いでしょう。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">また、Symfony2 では<em>あらゆるもの</em>をセキュアにすることができるということを、後で学ぶことになります。特定のコントローラやオブジェクト、そして PHP のメソッドまでもです。</p>
</div>
</div>
</div>
<div class="section" id="book-security-form-login">
<span id="id5"></span><h2>従来のログインフォームの使用<a class="headerlink" href="#book-security-form-login" title="Permalink to this headline">¶</a></h2>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>このセクションでは、 <tt class="docutils literal"><span class="pre">security.yml</span></tt> ファイルに定義されているハードコーディングされたユーザをそのまま使用します。そして、基本的なログインフォームの作り方を学びます。</p>
<p class="last">データベースからユーザをロードする方法は、 <a class="reference internal" href="../cookbook/security/entity_provider.html"><em>データベースからセキュリティユーザをロードする方法(エンティティプロバイダ)</em></a> を参照してください。そのクックブックの記事と、このセクションを読めば、データベースを使用したユーザのログインフォームを作成することができるようになるでしょう。</p>
</div>
<p>あなたのアプリケーションをファイアーウォールの管理下に配置する方法を学びました。そして、権限の必要な場所へのアクセスを保護する方法も学びました。HTTP 認証を使用すれば、全てのブラウザで動くユーザ名とパスワードの入力ボックスを、楽に活用することができます。しかし、Symfony はそれ以外の多くの認証メカニズムもサポートしています。詳細は <a class="reference internal" href="../reference/configuration/security.html"><em>Security Configuration Reference</em></a> を参照してください。</p>
<p>このセクションでは、従来の HTML のログインフォームを用いたユーザ認証で、この処理を強化していきます。</p>
<p>まず、ファイアーウォールの元でフォームログインを有効化します:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">secured_area</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>    <span class="l-Scalar-Plain">^/</span>
            <span class="l-Scalar-Plain">anonymous</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
            <span class="l-Scalar-Plain">form_login</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">login_path</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/login</span>
                <span class="l-Scalar-Plain">check_path</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">/login_check</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="nt">&lt;srv:container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/security&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:srv=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;config&gt;</span>
        <span class="nt">&lt;firewall</span> <span class="na">name=</span><span class="s">&quot;secured_area&quot;</span> <span class="na">pattern=</span><span class="s">&quot;^/&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;anonymous</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;form-login</span> <span class="na">login_path=</span><span class="s">&quot;/login&quot;</span> <span class="na">check_path=</span><span class="s">&quot;/login_check&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/firewall&gt;</span>
    <span class="nt">&lt;/config&gt;</span>
<span class="nt">&lt;/srv:container&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;secured_area&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;pattern&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/&#39;</span><span class="p">,</span>
            <span class="s1">&#39;anonymous&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
            <span class="s1">&#39;form_login&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;login_path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/login&#39;</span><span class="p">,</span>
                <span class="s1">&#39;check_path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/login_check&#39;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><tt class="docutils literal"><span class="pre">login_path</span></tt> や <tt class="docutils literal"><span class="pre">check_path</span></tt> の値をデフォルト値のまま使用し、カスタマイズする必要がなければ、設定は短くすることができます:</p>
<div class="last configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">form_login</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;form-login</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="s1">&#39;form_login&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<p>これで、セキュリティシステムは認証処理を初期化することができましたので、ユーザをログインフォーム(デフォルトでは <tt class="docutils literal"><span class="pre">/login</span></tt>)へリダイレクトするようになりました。ログインフォームの見た目の実装は、あなたの仕事です。まず、２つのルートを作成します。１つはログインフォームを表示するルート(<tt class="docutils literal"><span class="pre">/login</span></tt>)です。もう１つはログインフォーム値を処理するルート(<tt class="docutils literal"><span class="pre">/login_check</span></tt>)です:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/routing.yml</span>
<span class="l-Scalar-Plain">login</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>   <span class="l-Scalar-Plain">/login</span>
    <span class="l-Scalar-Plain">defaults</span><span class="p-Indicator">:</span>  <span class="p-Indicator">{</span> <span class="nv">_controller</span><span class="p-Indicator">:</span> <span class="nv">AcmeSecurityBundle</span><span class="p-Indicator">:</span><span class="nv">Security</span><span class="p-Indicator">:</span><span class="nv">login</span> <span class="p-Indicator">}</span>
<span class="l-Scalar-Plain">login_check</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>   <span class="l-Scalar-Plain">/login_check</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/routing.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>

<span class="nt">&lt;routes</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/routing&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/routing http://symfony.com/schema/routing/routing-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;route</span> <span class="na">id=</span><span class="s">&quot;login&quot;</span> <span class="na">pattern=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;default</span> <span class="na">key=</span><span class="s">&quot;_controller&quot;</span><span class="nt">&gt;</span>AcmeSecurityBundle:Security:login<span class="nt">&lt;/default&gt;</span>
    <span class="nt">&lt;/route&gt;</span>
    <span class="nt">&lt;route</span> <span class="na">id=</span><span class="s">&quot;login_check&quot;</span> <span class="na">pattern=</span><span class="s">&quot;/login_check&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/routes&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/routing.php</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing\RouteCollection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing\Route</span><span class="p">;</span>

<span class="nv">$collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RouteCollection</span><span class="p">();</span>
<span class="nv">$collection</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;_controller&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;AcmeDemoBundle:Security:login&#39;</span><span class="p">,</span>
<span class="p">)));</span>
<span class="nv">$collection</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;login_check&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Route</span><span class="p">(</span><span class="s1">&#39;/login_check&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">()));</span>

<span class="k">return</span> <span class="nv">$collection</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ファイアーウォールが <tt class="docutils literal"><span class="pre">/login_check</span></tt> URL へのフォーム送信を自動的に見つけて処理するので、この URL のコントローラを実装する必要は <em>ありません</em> 。</p>
</div>
<div class="versionadded">
<p><span>New in version 2.1: </span>Symfony 2.1 では、<tt class="docutils literal"><span class="pre">login_path</span></tt> <tt class="docutils literal"><span class="pre">check_path</span></tt> <tt class="docutils literal"><span class="pre">logout</span></tt> の URL を、それぞれ  <tt class="docutils literal"><span class="pre">/login</span></tt> 、 <tt class="docutils literal"><span class="pre">/login_check</span></tt> 、 <tt class="docutils literal"><span class="pre">/logout</span></tt> (- <a href="#id25"><span class="problematic" id="id26">`Logging Out`_</span></a> を参照してください) のようにルートを設定する <em>必要があります</em> 。</p>
</div>
<p><tt class="docutils literal"><span class="pre">login</span></tt> ルートの名前は重要ではありません。セキュリティシステムがログインが必要なユーザにリダイレクトするので、重要なのは(<tt class="docutils literal"><span class="pre">/login</span></tt>)ルートの URL が <tt class="docutils literal"><span class="pre">login_path</span></tt> の設定値にマッチすることです。</p>
<p>次はログインフォームを表示するコントローラを作成します:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Acme/SecurityBundle/Controller/Main;</span>
<span class="k">namespace</span> <span class="nx">Acme\SecurityBundle\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\SecurityContext</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SecurityController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">loginAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">();</span>
        <span class="nv">$session</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getSession</span><span class="p">();</span>

        <span class="c1">// ログインエラーがあれば、ここで取得</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="nx">SecurityContext</span><span class="o">::</span><span class="na">AUTHENTICATION_ERROR</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">SecurityContext</span><span class="o">::</span><span class="na">AUTHENTICATION_ERROR</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">SecurityContext</span><span class="o">::</span><span class="na">AUTHENTICATION_ERROR</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;AcmeSecurityBundle:Security:login.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="c1">// ユーザによって前回入力された username</span>
            <span class="s1">&#39;last_username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">SecurityContext</span><span class="o">::</span><span class="na">LAST_USERNAME</span><span class="p">),</span>
            <span class="s1">&#39;error&#39;</span>         <span class="o">=&gt;</span> <span class="nv">$error</span><span class="p">,</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ユーザがフォーム送信を行うと、セキュリティシステムは自動的にフォーム送信値を処理します。ユーザ名とパスワードで無効であった際には、コントローラはセキュリティシステムからフォームエラーの有を受け取り、ユーザにその内容を表示します。</p>
<p>つまり、セキュリティシステムがユーザ名とパスワードを処理し、ユーザ認証を行なってくれるので、あなたの実装するべきことは、ログインフォームの表示、そしてログインエラーがある際にはその内容の表示になります。</p>
<p>それでは、対応するテンプレートを作成しましょう:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Twig</em><div class="highlight-html+jinja"><div class="highlight"><pre><span class="c">{# src/Acme/SecurityBundle/Resources/views/Security/login.html.twig #}</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">error</span> <span class="cp">%}</span>
    <span class="nt">&lt;div&gt;</span><span class="cp">{{</span> <span class="nv">error.message</span> <span class="cp">}}</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">path</span><span class="o">(</span><span class="s1">&#39;login_check&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>Username:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;username&quot;</span> <span class="na">name=</span><span class="s">&quot;_username&quot;</span> <span class="na">value=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">last_username</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>Password:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">id=</span><span class="s">&quot;password&quot;</span> <span class="na">name=</span><span class="s">&quot;_password&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">{#</span>
<span class="c">        認証成功した際のリダイレクト URL を制御したい場合(詳細は以下に説明する)</span>
<span class="c">        &lt;input type=&quot;hidden&quot; name=&quot;_target_path&quot; value=&quot;/account&quot; /&gt;</span>
<span class="c">    #}</span>

    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;login&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="c1">// src/Acme/SecurityBundle/Resources/views/Security/login.html.php ?&gt;</span>
<span class="o">&lt;?</span><span class="nx">php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$error</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;div&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$error</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()</span> <span class="cp">?&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$view</span><span class="p">[</span><span class="s1">&#39;router&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">generate</span><span class="p">(</span><span class="s1">&#39;login_check&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>Username:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;username&quot;</span> <span class="na">name=</span><span class="s">&quot;_username&quot;</span> <span class="na">value=</span><span class="s">&quot;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$last_username</span> <span class="cp">?&gt;</span><span class="s">&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>Password:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">id=</span><span class="s">&quot;password&quot;</span> <span class="na">name=</span><span class="s">&quot;_password&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">        認証成功した際のリダイレクト URL を制御したい場合(詳細は以下に説明する)</span>
<span class="c">        &lt;input type=&quot;hidden&quot; name=&quot;_target_path&quot; value=&quot;/account&quot; /&gt;</span>
<span class="c">    --&gt;</span>

    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;login&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">テンプレートに渡される <tt class="docutils literal"><span class="pre">error</span></tt> 変数は <tt class="docutils literal"><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/Exception/AuthenticationException.html" title="Symfony\Component\Security\Core\Exception\AuthenticationException"><span class="pre">AuthenticationException</span></a></tt> のインスタンスです。 <tt class="docutils literal"><span class="pre">error</span></tt> 変数は、認証失敗に関する機密な情報など、たくさんの情報を保持していますので、賢く使ってください。</p>
</div>
<p>このフォームには、必須条件はほとんどありません。まず <tt class="docutils literal"><span class="pre">login_check</span></tt> ルートに基づき、<tt class="docutils literal"><span class="pre">/login_check</span></tt> にフォームが送信されます。セキュリティシステムがフォーム送信値をインターセプトして、自動的にフォームを処理します。次に、セキュリティシステムは <tt class="docutils literal"><span class="pre">_username</span></tt> と <tt class="docutils literal"><span class="pre">_password</span></tt> で指定されているフィールド(これらのフィールド名については <a class="reference internal" href="../reference/configuration/security.html#reference-security-firewall-form-login"><em>configured</em></a> を参照してください)が送信されていることを想定します。</p>
<p>これでできました。フォームを送信すると、セキュリティシステムは自動的にユーザの証明を行い、ユーザの認証を行います、また、認証に失敗した際には、エラーを表示して再びログインフォームを返します。</p>
<p>全ての処理を復習します:</p>
<ol class="arabic simple">
<li>ユーザは保護されたリソースへのアクセスを試みます。</li>
<li>ファイアーウォールは、ログインフォーム(<tt class="docutils literal"><span class="pre">/login</span></tt>)へユーザをリダイレクトし、認証処理を開始します。</li>
<li><tt class="docutils literal"><span class="pre">/login</span></tt> ページはこのサンプルで作られたルートとコントローラを経て、ログインフォームを返します。</li>
<li>ユーザはログインフォームを <tt class="docutils literal"><span class="pre">/login_check</span></tt> に送信します。</li>
<li>セキュリティシステムは、リクエストをインターセプトし、ユーザが送信した証明書を調べ、認証を行います。そして、認証失敗をした際には、ログインフォームを再び返します。</li>
</ol>
<p>デフォルトでは、送信された証明書が正しければ、ユーザは最初にリクエストしたページにリダイレクトされます(<tt class="docutils literal"><span class="pre">/admin/foo</span></tt> など)。ユーザが直接ログインページにリクエストしていた際には、 <tt class="docutils literal"><span class="pre">homepage</span></tt> にリダイレクトされます。もちろん特定の URL にリダイレクトするなど、カスタマイズもできます。</p>
<p>一般的なフォームログインの処理をカスタマイズする方法など、詳細は <a class="reference internal" href="../cookbook/security/form_login.html"><em>フォームログインをカスタマイズする方法</em></a> を参照してください。</p>
<div class="sidebar" id="book-security-common-pitfalls">
<p class="first sidebar-title">よくある落とし穴を避ける</p>
<p>ログインフォームを組み立てる差には、少しよくある落とし穴に注意してください。</p>
<p><strong>1. 正しいルートを作成すること</strong></p>
<p>まず、<tt class="docutils literal"><span class="pre">/login</span></tt> と <tt class="docutils literal"><span class="pre">/login_check</span></tt> ルートが、それぞれ対応する <tt class="docutils literal"><span class="pre">login_path</span></tt> と <tt class="docutils literal"><span class="pre">check_path</span></tt> の設定値に正しく定義されているか確認してください。ここでの設定ミスはログインページではなく、404ページへリダイレクトされることを意味します。または、ログインフォームの送信先が存在しないこととなります(同じログインフォームを何度も見ることになります)。</p>
<p><strong>2. ログインページはセキュアから除外してあること</strong></p>
<p>ログインページを閲覧するのに権限が/ <em>不要</em>/ にしてあることを確認してください。例えば次の設定では、<tt class="docutils literal"><span class="pre">/login</span></tt> URL を含む全ての URL で <tt class="docutils literal"><span class="pre">ROLE_ADMIN</span></tt> 権限を必須にしているため、リダイレクトループに陥ります:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">access_control</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">path</span><span class="p-Indicator">:</span> <span class="nv">^/</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="nv">ROLE_ADMIN</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;access-control&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_ADMIN&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/access-control&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">),</span>
<span class="p">),</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>次のように <tt class="docutils literal"><span class="pre">/login</span></tt> URL へのアクセス制御を取り除くことで、この問題は解決されます:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">access_control</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">path</span><span class="p-Indicator">:</span> <span class="nv">^/login</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="nv">IS_AUTHENTICATED_ANONYMOUSLY</span> <span class="p-Indicator">}</span>
    <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">path</span><span class="p-Indicator">:</span> <span class="nv">^/</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="nv">ROLE_ADMIN</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;access-control&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/login&quot;</span> <span class="na">role=</span><span class="s">&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_ADMIN&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/access-control&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/login&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;IS_AUTHENTICATED_ANONYMOUSLY&#39;</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">),</span>
<span class="p">),</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>また、ファイアーウォールで匿名ユーザによるアクセスを/ <em>許可していなければ</em>/ 、ログインページ用の特別なファイアーウォールを用意し、匿名ユーザによるアクセスを許可してください:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">login_firewall</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>    <span class="l-Scalar-Plain">^/login$</span>
        <span class="l-Scalar-Plain">anonymous</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">~</span>
    <span class="l-Scalar-Plain">secured_area</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>    <span class="l-Scalar-Plain">^/</span>
        <span class="l-Scalar-Plain">form_login</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;firewall</span> <span class="na">name=</span><span class="s">&quot;login_firewall&quot;</span> <span class="na">pattern=</span><span class="s">&quot;^/login$&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;anonymous</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/firewall&gt;</span>
<span class="nt">&lt;firewall</span> <span class="na">name=</span><span class="s">&quot;secured_area&quot;</span> <span class="na">pattern=</span><span class="s">&quot;^/&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form_login</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/firewall&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;login_firewall&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;pattern&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/login$&#39;</span><span class="p">,</span>
        <span class="s1">&#39;anonymous&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
    <span class="p">),</span>
    <span class="s1">&#39;secured_area&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;pattern&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/&#39;</span><span class="p">,</span>
        <span class="s1">&#39;form_login&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
    <span class="p">),</span>
<span class="p">),</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p><strong>3. /login_check がファイアーウォール内にあること</strong></p>
<p>次に <tt class="docutils literal"><span class="pre">check_path</span></tt> の URL <tt class="docutils literal"><span class="pre">/login_check</span></tt> が、フォームログインを使用するファイアーウォール内にあることを確認してください。この例では、１つのファイアーウォールが <tt class="docutils literal"><span class="pre">/login_check</span></tt> を含む<em>全ての</em> URL にマッチします。もし <tt class="docutils literal"><span class="pre">/login_check</span></tt> がどのファイアーウォールにもマッチしなければ、<tt class="docutils literal"><span class="pre">Unable</span> <span class="pre">to</span> <span class="pre">find</span> <span class="pre">the</span> <span class="pre">controller</span> <span class="pre">for</span> <span class="pre">path</span> <span class="pre">&quot;login_check&quot;</span></tt> 例外に引っかかるでしょう。</p>
<p><strong>4. 複数のファイアーウォールでセキュリティコンテキストを共有しないこと</strong></p>
<p class="last">複数のファイアーウォールを使用しており、そのうちの１つのファイアーウォールに対して認証をする際には、他のファイアーウォールに対して自動的には<em>認証されません</em>。異なるファイアーウォールは、異なるセキュリティシステムとなります。ほとんどのアプリケーションでは、１つのファイアーウォールで十分です。</p>
</div>
</div>
<div class="section" id="id6">
<h2>承認<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>セキュリティ機能の第一ステップは必ずユーザの誰かを証明する処理をする認証となります。Symfony では、認証はフォームログイン、HTTP ベーシック認証、Facebook 認証など、あらゆる認証方法を使うことができます。</p>
<p>一度、ユーザが認証されると、承認を開始します。承認は、標準的で強力な方法を提供し、URL、モデルオブジェクト、メソッド呼び出しなどのリソースに対して、あるユーザがアクセス可能かどうかを判断します。つまり、承認処理は、それぞれのユーザに特定の権限を割り当てて、異なるリソースに対し異なる権限が必要である、ということによって作動します。</p>
<p>承認処理は、２つの異なる側面があります:</p>
<ol class="arabic simple">
<li>あるユーザが特定の権限のセットを保持している。</li>
<li>あるリソースへのアクセスに、特定の権限を必要としている。</li>
</ol>
<p>このセクションでは、URL やメソッド呼び出しなどの異なるリソースをセキュアにする方法を学びます。それから後に、どのように権限が作られて、ユーザに割り当てられるのかを学びます。</p>
<div class="section" id="url">
<h3>特定の URL パターンをセキュアにする<a class="headerlink" href="#url" title="Permalink to this headline">¶</a></h3>
<p>アプリケーションの一部をセキュアにする最も基本的な方法は、全ての URL パターンをセキュアにすることです。それは、この章の最初のサンプルにありましたように、正規表現パターンの <tt class="docutils literal"><span class="pre">/^admin</span></tt> にマッチする全ての URL に <tt class="docutils literal"><span class="pre">ROLE_ADMIN</span></tt> 権限を必須にすることでした。</p>
<p>必要なだけ、 URL パターンを正規表現で定義することができます。</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l-Scalar-Plain">access_control</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">path</span><span class="p-Indicator">:</span> <span class="nv">^/admin/users</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="nv">ROLE_SUPER_ADMIN</span> <span class="p-Indicator">}</span>
        <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">path</span><span class="p-Indicator">:</span> <span class="nv">^/admin</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="nv">ROLE_ADMIN</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;access-control&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/admin/users&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_SUPER_ADMIN&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/admin&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_ADMIN&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/access-control&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="c1">// ...</span>
    <span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/admin/users&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_SUPER_ADMIN&#39;</span><span class="p">),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/admin&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><tt class="docutils literal"><span class="pre">^</span></tt> をパスの先頭に追加することは、そのパターンから<em>始まる</em> URL にのみマッチすることを保証します。例えば、<tt class="docutils literal"><span class="pre">^</span></tt> の無い単なる <tt class="docutils literal"><span class="pre">/admin</span></tt> パスは <tt class="docutils literal"><span class="pre">/admin/foo</span></tt> にマッチしますし、<tt class="docutils literal"><span class="pre">/foo/admin</span></tt> にもマッチしてしまいます。</p>
</div>
<p>Symfony2 は、受け取る全てのリクエストに対し、アクセス制御ルールへのマッチを探そうと試みます(最初にマッチしたものが優先されます)。ユーザが認証されていなければ、ユーザにログインする機会が与えられ、認証処理が始まります。しかし、ユーザが<em>認証されている</em>が、必要な権限がない場合は <tt class="docutils literal"><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/Exception/AccessDeniedException.html" title="Symfony\Component\Security\Core\Exception\AccessDeniedException"><span class="pre">AccessDeniedException</span></a></tt> 例外が投げられます。そして、&#8221;access denied&#8221; のエラーページをユーザに返します。エラーページの詳細は、<a class="reference internal" href="../cookbook/controller/error_pages.html"><em>エラーページのカスタマイズ方法</em></a> を参照してください。</p>
<p>Symfony は最初にマッチしたアクセス制御ルールを使用するので、<tt class="docutils literal"><span class="pre">/admin/users/new</span></tt> のような URL は <tt class="docutils literal"><span class="pre">ROLE_SUPER_ADMIN</span></tt> 権限を必要とする最初のルールにマッチします。<tt class="docutils literal"><span class="pre">/admin/blog</span></tt> のような全ての URL は <tt class="docutils literal"><span class="pre">ROLE_ADMIN</span></tt> を必要とする２番目のルールにマッチします。</p>
</div>
<div class="section" id="ip">
<span id="book-security-securing-ip"></span><h3>IP によるセキュア化<a class="headerlink" href="#ip" title="Permalink to this headline">¶</a></h3>
<p>ルートに対するアクセスを IP に基づいて制限する必要があるときもあるでしょう。特に <a class="reference internal" href="http_cache.html#edge-side-includes"><em>Edge Side Includes</em></a> (ESI) を使用して、 &#8220;_internal&#8221; と命名されたルートを使用するときなどです。 ESI の使用では、ゲートウェイキャッシュがそのページ内のサブセクションの異なるキャッシュオプションを有効にする _internal ルートが必要とされます。このルートは、Symfony のスタンダードエディションのデフォルトでは ^/_internal 接頭辞が付いています（ルーティングファイルからこれらの行をアンコメントしていることを想定しています）</p>
<p>以下に、外部からのアクセスからこのルートに対するセキュア化の例を示します。</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l-Scalar-Plain">access_control</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">path</span><span class="p-Indicator">:</span> <span class="nv">^/_internal</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="nv">IS_AUTHENTICATED_ANONYMOUSLY</span><span class="p-Indicator">,</span> <span class="nv">ip</span><span class="p-Indicator">:</span> <span class="nv">127.0.0.1</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;access-control&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/_internal&quot;</span> <span class="na">role=</span><span class="s">&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;</span> <span class="na">ip=</span><span class="s">&quot;127.0.0.1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/access-control&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/_internal&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;IS_AUTHENTICATED_ANONYMOUSLY&#39;</span><span class="p">,</span> <span class="s1">&#39;ip&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">),</span>
<span class="p">),</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="book-security-securing-channel">
<span id="id7"></span><h3>チャンネルによるセキュア化<a class="headerlink" href="#book-security-securing-channel" title="Permalink to this headline">¶</a></h3>
<p>IP によるセキュア化と同じように、新しく aaccess_control のエントリに SSL の使用を追加するだけです。</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l-Scalar-Plain">access_control</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">path</span><span class="p-Indicator">:</span> <span class="nv">^/cart/checkout</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="nv">IS_AUTHENTICATED_ANONYMOUSLY</span><span class="p-Indicator">,</span> <span class="nv">requires_channel</span><span class="p-Indicator">:</span> <span class="nv">https</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;access-control&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/cart/checkout&quot;</span> <span class="na">role=</span><span class="s">&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;</span> <span class="na">requires_channel=</span><span class="s">&quot;https&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/access-control&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/cart/checkout&#39;</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;IS_AUTHENTICATED_ANONYMOUSLY&#39;</span><span class="p">,</span> <span class="s1">&#39;requires_channel&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;https&#39;</span><span class="p">),</span>
<span class="p">),</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="book-security-securing-controller">
<span id="id8"></span><h3>コントローラをセキュアにする<a class="headerlink" href="#book-security-securing-controller" title="Permalink to this headline">¶</a></h3>
<p>URL パターンに基づくアプリケーションの保護は簡単でした。しかし、全てのケースにおいて、十分きめ細かいとは言えません。必要であれば、コントローラの内部から認証を強制させることも簡単にできます。</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Exception\AccessDeniedException</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">helloAction</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;security.context&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">isGranted</span><span class="p">(</span><span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">AccessDeniedException</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p id="book-security-securing-controller-annotations">任意ですが、<tt class="docutils literal"><span class="pre">JMSSecurityExtraBundle</span></tt> をインストールして、アノテーションを用いてコントローラをセキュアにすることもできます。</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">use</span> <span class="nx">JMS\SecurityExtraBundle\Annotation\Secure</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @Secure(roles=&quot;ROLE_ADMIN&quot;)</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">helloAction</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>詳細は <a class="reference external" href="https://github.com/schmittjoh/JMSSecurityExtraBundle">JMSSecurityExtraBundle</a> のドキュメントを参照してください。Symfony のスタンダードディストリビューションを使用する際は、このバンドルはデフォルトで有効になっています。そうでなくても、簡単にダウンロードしてインストールすることができます。</p>
</div>
<div class="section" id="id9">
<h3>他のサービスをセキュアにする<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>実際は、前のセクションで見た戦略と同じように、Symfony における全てのものは保護することができます。例えば、 PHP クラスを使用して、あるユーザから他のユーザにメールを送信するサービスがあったとします。特定の権限を持つユーザは、使用場所に関係無く、このクラスの使用を制限することができます。</p>
<p>アプリケーション内の異なるサービスやメソッド間をセキュアにする、セキュリティコンポーネントの使用方法に関する詳細は、<a class="reference internal" href="../cookbook/security/securing_services.html"><em>アプリケーション内でサービスやメソッドをセキュアにする方法</em></a> を参照してください。</p>
</div>
<div class="section" id="acls">
<h3>アクセス制御リスト (ACLs): 個々のデータベースオブジェクトをセキュアにする<a class="headerlink" href="#acls" title="Permalink to this headline">¶</a></h3>
<p>ユーザが投稿に対してコメントのできるブログシステムを設計していることを想像してみてください。ユーザには自分のコメントを編集できるようにしたいとします。しかし、他のユーザのコメントの編集はできないようにしたいとします。また、管理者ユーザであれば、<em>全て</em>のコメントの編集を可能にしたいとします。</p>
<p>セキュリティコンポーネントは、任意のアクセス制御リスト(ACL)システムが付いてきます。アクセス制御リストシステムは、あなたのシステムのオブジェクトの個々のインスタンスへのアクセスを制御する必要する際に使用することができます。 ACL <em>無し</em> で、あなたのシステムをセキュアにして、特定のユーザのみブログのコメントを編集できるようにすることはできます。しかし、 ACL が <em>有れば</em> 、コメントごとの制限やアクセスを受け入れることもできるのです。</p>
<p>詳細は、クックブックの <a class="reference internal" href="../cookbook/security/acl.html"><em>アクセス制御リスト(ACL)</em></a> を参照してください。</p>
</div>
</div>
<div class="section" id="id10">
<h2>ユーザ<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>前のセクションでは、あるリソースへの/ <em>権限</em>/ のセットを必須とすることによって、異なるリソースの保護の仕方を学びました。このセクションでは、ユーザの承認の他の側面を探っていきます。</p>
<div class="section" id="id11">
<h3>ユーザはどこから来た？ (<em>ユーザプロバイダ</em>)<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>認証の際に、ユーザは証明書のセット(だいたいの場合ユーザ名とパスワードになります)を送信します。認証システムの仕事は、ユーザのプールに対し、証明書のマッチをすることです。では、そのユーザのリストはどこから来るのでしょうか？</p>
<p>Symfony2 では、ユーザは、コンフィギュレーションファイル、データベーステーブル、ウェブサービスなど、あらゆるところに保管することができます。ユーザを認証システムに提供するする機能は総称して、&#8221;ユーザプロバイダ&#8221;と呼びます。Symfony2 では、２つの一般的なユーザプロバイダが標準で付いてきます。１つは、コンフィギュレーションファイルからユーザをロードし、もう１つは、データベーステーブルからユーザをロードします。</p>
<div class="section" id="id12">
<h4>コンフィギュレーションファイルでユーザを特定する<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>ユーザを特定する最も簡単な方法は直接コンフィギュレーションファイルで指定する方法です。実際のところ、それは、この章のサンプルで今まで見てきた方法です。</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l-Scalar-Plain">providers</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">default_provider</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">users</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">ryan</span><span class="p-Indicator">:</span>  <span class="p-Indicator">{</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">ryanpass</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="s">&#39;ROLE_USER&#39;</span> <span class="p-Indicator">}</span>
                <span class="l-Scalar-Plain">admin</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">kitten</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="s">&#39;ROLE_ADMIN&#39;</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">&quot;default_provider&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;ryan&quot;</span> <span class="na">password=</span><span class="s">&quot;ryanpass&quot;</span> <span class="na">roles=</span><span class="s">&quot;ROLE_USER&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;admin&quot;</span> <span class="na">password=</span><span class="s">&quot;kitten&quot;</span> <span class="na">roles=</span><span class="s">&quot;ROLE_ADMIN&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/provider&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="c1">// ...</span>
    <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;default_provider&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;ryan&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ryanpass&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_USER&#39;</span><span class="p">),</span>
                <span class="s1">&#39;admin&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;kitten&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>このユーザプロバイダは、ユーザ情報がデータベースに保管されていないので、&#8221;in-memory&#8221; ユーザプロバイダと呼ばれます。実際のユーザオブジェクトは Symfony によって提供されます(<tt class="docutils literal"><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/User.html" title="Symfony\Component\Security\Core\User\User"><span class="pre">User</span></a></tt>)。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">全てのユーザプロバイダは、<tt class="docutils literal"><span class="pre">users</span></tt> 設定値にユーザをリスト化して特定化することにより、コンフィギュレーションから直接ユーザをロードすることができます。</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p>ユーザ名が <tt class="docutils literal"><span class="pre">77</span></tt> などの数字であった際や、<tt class="docutils literal"><span class="pre">user-name</span></tt> のようにハイフンを含んでいる際には、YAMLでのユーザ指定は代替のシンタックスを使用する必要があります:</p>
<div class="last highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">users</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">name</span><span class="p-Indicator">:</span> <span class="nv">77</span><span class="p-Indicator">,</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">pass</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="s">&#39;ROLE_USER&#39;</span> <span class="p-Indicator">}</span>
    <span class="p-Indicator">-</span> <span class="p-Indicator">{</span> <span class="nv">name</span><span class="p-Indicator">:</span> <span class="nv">user-name</span><span class="p-Indicator">,</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">pass</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="s">&#39;ROLE_USER&#39;</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</div>
<p>小さなサイトにおいては、この方法によるセットアップが速く簡単でしょう。より複雑なシステムでは、データベースからユーザをロードすることになるでしょう。</p>
</div>
<div class="section" id="book-security-user-entity">
<span id="id13"></span><h4>データベースからユーザをロードする<a class="headerlink" href="#book-security-user-entity" title="Permalink to this headline">¶</a></h4>
<p>Doctrine ORM を介してユーザをロードするには、<tt class="docutils literal"><span class="pre">User</span></tt> クラスを作成し <tt class="docutils literal"><span class="pre">entity</span></tt> プロバイダを設定するだけなので簡単です。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Doctrine ORM や ODM を介してユーザを保存するすることを可能とする、質の高いオープンソースのバンドルが入手可能です。詳細は GitHub 上の <a class="reference external" href="https://github.com/FriendsOfSymfony/FOSUserBundle">FOSUserBundle</a> を参照してください。</p>
</div>
<p>このアプローチでは、まず、独自の <tt class="docutils literal"><span class="pre">User</span></tt> クラスを作成します。これはデータベースに保存されます。</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Acme/UserBundle/Entity/User.php</span>
<span class="k">namespace</span> <span class="nx">Acme\UserBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\User\UserInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">User</span> <span class="k">implements</span> <span class="nx">UserInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;, length=&quot;255&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$username</span><span class="p">;</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>セキュリティシステムを考慮する限り、独自に作成するカスタムユーザクラスの唯一の必須条件は、<tt class="docutils literal"><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/UserInterface.html" title="Symfony\Component\Security\Core\User\UserInterface"><span class="pre">UserInterface</span></a></tt> インタフェースを実装することです。つまり、このインタフェースさえ実装すれば&#8221;user&#8221;はどんなものでも構いません。</p>
<div class="versionadded">
<p><span>New in version 2.1: </span>Symfony 2.1 では、 <tt class="docutils literal"><span class="pre">equals</span></tt> メソッドが <tt class="docutils literal"><span class="pre">UserInterface</span></tt> から取り除かれました。デフォルトの比較のロジックの実装をオーバーライドする必要がある際には、 <tt class="docutils literal"><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/EquatableInterface.html" title="Symfony\Component\Security\Core\User\EquatableInterface"><span class="pre">EquatableInterface</span></a></tt> インタフェースを実装してください。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ユーザオブジェクトは、リクエストの間中、 シリアライズ化され、セッションに保存されますので、ユーザオブジェクトに<a class="reference external" href="http://php.net/manual/en/class.serializable.php">\Serializable インタフェースを実装</a>することを推奨します。特に <tt class="docutils literal"><span class="pre">User</span></tt> クラスがプライベート属性を持つ親クラスから継承している際に、重要です。</p>
</div>
<p>次に <tt class="docutils literal"><span class="pre">entity</span></tt> ユーザプロバイダを設定して、作成した <tt class="docutils literal"><span class="pre">User</span></tt> クラスを指定します:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">providers</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">main</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">entity</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">class</span><span class="p-Indicator">:</span> <span class="nv">Acme\UserBundle\Entity\User</span><span class="p-Indicator">,</span> <span class="nv">property</span><span class="p-Indicator">:</span> <span class="nv">username</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/security.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;entity</span> <span class="na">class=</span><span class="s">&quot;Acme\UserBundle\Entity\User&quot;</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/provider&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;main&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;entity&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Acme\UserBundle\Entity\User&#39;</span><span class="p">,</span> <span class="s1">&#39;property&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;username&#39;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>この新しいプロバイダの導入では、認証システムは <tt class="docutils literal"><span class="pre">username</span></tt> フィールドを使用してデータベースから <tt class="docutils literal"><span class="pre">User</span></tt> オブジェクトをロードしようとします。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">このサンプルでは、<tt class="docutils literal"><span class="pre">entity</span></tt> プロバイダの背後にある基本的な考え方を見せました。より実践的なサンプルは、<a class="reference internal" href="../cookbook/security/entity_provider.html"><em>データベースからセキュリティユーザをロードする方法(エンティティプロバイダ)</em></a> を参照してください。</p>
</div>
<p>ウェブサービスを介してユーザをロードするなどの、カスタムプロバイダの作成方法に関する詳細は、<a class="reference internal" href="../cookbook/security/custom_provider.html"><em>カスタムユーザプロバイダの作成方法</em></a> を参照してください。</p>
</div>
</div>
<div class="section" id="book-security-encoding-user-password">
<span id="id14"></span><h3>ユーザパスワードのエンコーディング<a class="headerlink" href="#book-security-encoding-user-password" title="Permalink to this headline">¶</a></h3>
<p>シンプルにするために、これまでの全てのサンプルでは、コンフィギュレーションファイルやデータベースに、ユーザのパスワードを平文で保存してきました。もちろん実際のアプリケーションでは、セキュリティの理由から、ユーザのパスワードをエンコードしたいと思うでしょう。パスワードのエンコードは、User クラスをいくつかのビルトインされている &#8220;encoders&#8221; にマッピングすることによって簡単に行うことができます。例えばユーザをメモリ上に保存し、<tt class="docutils literal"><span class="pre">sha1</span></tt> を介してパスワードをわかりにくくするためには次のようにします:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l-Scalar-Plain">providers</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">in_memory</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">users</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">ryan</span><span class="p-Indicator">:</span>  <span class="p-Indicator">{</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">bb87a29949f3a1ee0559f8a57357487151281386</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="s">&#39;ROLE_USER&#39;</span> <span class="p-Indicator">}</span>
                <span class="l-Scalar-Plain">admin</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">74913f5cd5f61ec0bcfdb775414c2fb3d161b620</span><span class="p-Indicator">,</span> <span class="nv">roles</span><span class="p-Indicator">:</span> <span class="s">&#39;ROLE_ADMIN&#39;</span> <span class="p-Indicator">}</span>

    <span class="l-Scalar-Plain">encoders</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">Symfony\Component\Security\Core\User\User</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">algorithm</span><span class="p-Indicator">:</span>   <span class="l-Scalar-Plain">sha1</span>
            <span class="l-Scalar-Plain">iterations</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
            <span class="l-Scalar-Plain">encode_as_base64</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">&quot;in_memory&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;ryan&quot;</span> <span class="na">password=</span><span class="s">&quot;bb87a29949f3a1ee0559f8a57357487151281386&quot;</span> <span class="na">roles=</span><span class="s">&quot;ROLE_USER&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;admin&quot;</span> <span class="na">password=</span><span class="s">&quot;74913f5cd5f61ec0bcfdb775414c2fb3d161b620&quot;</span> <span class="na">roles=</span><span class="s">&quot;ROLE_ADMIN&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/provider&gt;</span>

    <span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">&quot;Symfony\Component\Security\Core\User\User&quot;</span> <span class="na">algorithm=</span><span class="s">&quot;sha1&quot;</span> <span class="na">iterations=</span><span class="s">&quot;1&quot;</span> <span class="na">encode_as_base64=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="c1">// ...</span>
    <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;in_memory&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;ryan&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bb87a29949f3a1ee0559f8a57357487151281386&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_USER&#39;</span><span class="p">),</span>
                <span class="s1">&#39;admin&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;74913f5cd5f61ec0bcfdb775414c2fb3d161b620&#39;</span><span class="p">,</span> <span class="s1">&#39;roles&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="s1">&#39;encoders&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;Symfony\Component\Security\Core\User\User&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;algorithm&#39;</span>         <span class="o">=&gt;</span> <span class="s1">&#39;sha1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;iterations&#39;</span>        <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;encode_as_base64&#39;</span>  <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p><tt class="docutils literal"><span class="pre">iterations</span></tt> を <tt class="docutils literal"><span class="pre">1</span></tt> に、<tt class="docutils literal"><span class="pre">encode_as_base64</span></tt> を false にセットすることによって、パスワードは追加のエンコード無しに <tt class="docutils literal"><span class="pre">sha1</span></tt> アルゴリズムを一度走らせたパスワードとなります。ハッシュ化されたパスワードはプログラム(<tt class="docutils literal"><span class="pre">hash('sha1',</span> <span class="pre">ryanpass')</span></tt>)でも、<a class="reference external" href="http://www.functions-online.com/sha1.html">functions-online.com</a> のようなオンラインツールでも作ることができます。</p>
<p>もしユーザを動的に作成して、データベースに保存しているのであれば、さらに強固なハッシュアルゴリズムを使うことができ、実際のパスワードエンコーダーオブジェクトをパスワードをエンコードさせることができます。例えば、上のサンプルのように、User オブジェクトが <tt class="docutils literal"><span class="pre">Acme\UserBundle\Entity\User</span></tt> であったとします。まず、ユーザのエンコードを設定します。</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="c1"># ...</span>

    <span class="l-Scalar-Plain">encoders</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">Acme\UserBundle\Entity\User</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sha512</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">&quot;Acme\UserBundle\Entity\User&quot;</span> <span class="na">algorithm=</span><span class="s">&quot;sha512&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="c1">// ...</span>

    <span class="s1">&#39;encoders&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;Acme\UserBundle\Entity\User&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;sha512&#39;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>このケースでは、さらに強力な <tt class="docutils literal"><span class="pre">sha512</span></tt> アルゴリズムを使用しています。また、単にアルゴリズムを (<tt class="docutils literal"><span class="pre">sha512</span></tt>)と文字列で指定したため、システムはパスワードを5000回連続でハッシュ化し、base64 でエンコードをします。言い換えると、パスワードは難読化され、ハッシュ化されたパスワードはデコードできなくなります(ハッシュ化されたパスワードから実際のパスワードを判断することができません)。</p>
<p>ユーザ登録フォームのようなものがあれば、あなたがユーザのためにハッシュ化されたパスワードを判断できるべきす。User オブジェクトに、どんなアルゴリズムで設定していても、ハッシュ化されたパスワードは常にコントローラから以下の方法で判断されます:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="nv">$factory</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;security.encoder_factory&#39;</span><span class="p">);</span>
<span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Acme\UserBundle\Entity\User</span><span class="p">();</span>

<span class="nv">$encoder</span> <span class="o">=</span> <span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">getEncoder</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="nv">$encoder</span><span class="o">-&gt;</span><span class="na">encodePassword</span><span class="p">(</span><span class="s1">&#39;ryanpass&#39;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getSalt</span><span class="p">());</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setPassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="user">
<h3>User オブジェクトの読み出し<a class="headerlink" href="#user" title="Permalink to this headline">¶</a></h3>
<p>認証後、現在のユーザの <tt class="docutils literal"><span class="pre">User</span></tt> オブジェクトには <tt class="docutils literal"><span class="pre">security.context</span></tt> サービスを介してアクセスできます。コントローラから使うには、次のようにします:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;security.context&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getUser</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>コントローラの中では、次のショートカットが使えます</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getUser</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">匿名ユーザは、表向きには、匿名ユーザのオブジェクトの <tt class="docutils literal"><span class="pre">isAuthenticated()</span></tt> メソッドが true を返すので認証されます。ユーザが実際に認証されたかを確認するには、<tt class="docutils literal"><span class="pre">IS_AUTHENTICATED_ANONYMOUSLY</span></tt> 権限をチェックしてください。</p>
</div>
<p>Twig のテンプレートでは、このオブジェクトは、 <tt class="docutils literal"><span class="pre">app.user</span></tt> キーで参照可能です。 <tt class="docutils literal"><span class="pre">app.user</span></tt> は、内部的には、 <tt class="docutils literal"><a class="reference external" href="http://api.symfony.com/master/Symfony/Bundle/FrameworkBundle/Templating/GlobalVariables.html#method_getUser" title="Symfony\Bundle\FrameworkBundle\Templating\GlobalVariables::getUser()"><span class="pre">GlobalVariables::getUser()</span></a></tt>  メソッドを呼んでいます:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Twig</em><div class="highlight-html+jinja"><div class="highlight"><pre><span class="nt">&lt;p&gt;</span>Username: <span class="cp">{{</span> <span class="nv">app.user.username</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="id15">
<h3>複数のユーザプロバイダの使用<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>HTTP 認証やフォームログインなどの全ての認証メカニズムは、厳密に１つのユーザプロバイダを使用し、デフォルトとして最初に宣言されたユーザプロバイダを使用します。しかし、特定のユーザはコンフィギュレーションファイルから、残りのユーザはデータベースから認証したいときはどうでしょう？これは、２つ一緒につなげる新しいプロバイダを作成することにより可能になります:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">providers</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">chain_provider</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">providers</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">in_memory</span><span class="p-Indicator">,</span> <span class="nv">user_db</span><span class="p-Indicator">]</span>
        <span class="l-Scalar-Plain">in_memory</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">users</span><span class="p-Indicator">:</span>
                    <span class="l-Scalar-Plain">foo</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">test</span> <span class="p-Indicator">}</span>
        <span class="l-Scalar-Plain">user_db</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">entity</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">class</span><span class="p-Indicator">:</span> <span class="nv">Acme\UserBundle\Entity\User</span><span class="p-Indicator">,</span> <span class="nv">property</span><span class="p-Indicator">:</span> <span class="nv">username</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">&quot;chain_provider&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;provider&gt;</span>in_memory<span class="nt">&lt;/provider&gt;</span>
        <span class="nt">&lt;provider&gt;</span>user_db<span class="nt">&lt;/provider&gt;</span>
    <span class="nt">&lt;/provider&gt;</span>
    <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">&quot;in_memory&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;memory&gt;</span>
            <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;foo&quot;</span> <span class="na">password=</span><span class="s">&quot;test&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/memory&gt;</span>
    <span class="nt">&lt;/provider&gt;</span>
    <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">&quot;user_db&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;entity</span> <span class="na">class=</span><span class="s">&quot;Acme\UserBundle\Entity\User&quot;</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/provider&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;chain_provider&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;in_memory&#39;</span><span class="p">,</span> <span class="s1">&#39;user_db&#39;</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="s1">&#39;in_memory&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;memory&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
               <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                   <span class="s1">&#39;foo&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">),</span>
               <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="s1">&#39;user_db&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;entity&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Acme\UserBundle\Entity\User&#39;</span><span class="p">,</span> <span class="s1">&#39;property&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;username&#39;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>これで、<tt class="docutils literal"><span class="pre">chain_provider</span></tt> を最初に指定したため、全ての認証メカニズムは <tt class="docutils literal"><span class="pre">chain_provider</span></tt> を使用するようになりました。<tt class="docutils literal"><span class="pre">chain_provider</span></tt> は、<tt class="docutils literal"><span class="pre">in_memory</span></tt> と <tt class="docutils literal"><span class="pre">user_db</span></tt> のプロバイダの両方からユーザをロードしようとします。</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><tt class="docutils literal"><span class="pre">in_memory</span></tt> のユーザと <tt class="docutils literal"><span class="pre">user_db</span></tt> のユーザを分ける理由がなければ、２つのソースを１つのプロバイダとして結合することによって、より簡単に達成することができます:</p>
<div class="last configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">providers</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">main_provider</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">users</span><span class="p-Indicator">:</span>
                    <span class="l-Scalar-Plain">foo</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">password</span><span class="p-Indicator">:</span> <span class="nv">test</span> <span class="p-Indicator">}</span>
            <span class="l-Scalar-Plain">entity</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">class</span><span class="p-Indicator">:</span> <span class="nv">Acme\UserBundle\Entity\User</span><span class="p-Indicator">,</span> <span class="nv">property</span><span class="p-Indicator">:</span> <span class="nv">username</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">=&quot;main_provider&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;memory&gt;</span>
            <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;foo&quot;</span> <span class="na">password=</span><span class="s">&quot;test&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/memory&gt;</span>
        <span class="nt">&lt;entity</span> <span class="na">class=</span><span class="s">&quot;Acme\UserBundle\Entity\User&quot;</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/provider&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;main_provider&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;memory&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;users&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;foo&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="s1">&#39;entity&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Acme\UserBundle\Entity\User&#39;</span><span class="p">,</span> <span class="s1">&#39;property&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;username&#39;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<p>また、特定のプロバイダを使用するため、ファイアーウォールや個々の認証メカニズムを設定することも可能です。くどいようですが、プロバイダが明確に指定されていなければ、最初のプロバイダが常に使用されます:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">secured_area</span><span class="p-Indicator">:</span>
            <span class="c1"># ...</span>
            <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">user_db</span>
            <span class="l-Scalar-Plain">http_basic</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">realm</span><span class="p-Indicator">:</span> <span class="s">&quot;Secured</span><span class="nv"> </span><span class="s">Demo</span><span class="nv"> </span><span class="s">Area&quot;</span>
                <span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">in_memory</span>
            <span class="l-Scalar-Plain">form_login</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;firewall</span> <span class="na">name=</span><span class="s">&quot;secured_area&quot;</span> <span class="na">pattern=</span><span class="s">&quot;^/&quot;</span> <span class="na">provider=</span><span class="s">&quot;user_db&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;http-basic</span> <span class="na">realm=</span><span class="s">&quot;Secured Demo Area&quot;</span> <span class="na">provider=</span><span class="s">&quot;in_memory&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;form-login</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/firewall&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;secured_area&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="c1">// ...</span>
            <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;user_db&#39;</span><span class="p">,</span>
            <span class="s1">&#39;http_basic&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="c1">// ...</span>
                <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;in_memory&#39;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="s1">&#39;form_login&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>この例では、ユーザが HTTP 認証を介してログインを試みようとすると、認証システムは <tt class="docutils literal"><span class="pre">in_memory</span></tt> ユーザプロバイダを使用します。しかし、ユーザがフォームログインを介してログインを試みようとすると、全体のデフォルトである <tt class="docutils literal"><span class="pre">user_db</span></tt> プロバイダが使用されます。</p>
<p>ユーザプロバイダとファイアーウォールの設定に関する詳細は、<a class="reference internal" href="../reference/configuration/security.html"><em>SecurityBundle 設定 (&#8220;security&#8221;)</em></a> を参照してください。</p>
</div>
</div>
<div class="section" id="id16">
<h2>権限<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h2>
<p>&#8220;role&#8221; のアイデアは、認証処理のキーとなります。それぞれのユーザは権限のセットを割り当てられ、それぞれのリソースは１つ、またはそれ以上の権限を必要とします。ユーザが必要な権限を持っていれば、アクセスは可能となり、そうでなければ拒否されます。</p>
<p>権限はとてもシンプルで、必要であれば独自に作り、使うことができるように、基本的にひと続きになっています。例えば、ウェブサイトのブログ管理のセクションへのアクセスを制限する必要があったとします。その際には、<tt class="docutils literal"><span class="pre">ROLE_BLOG_ADMIN</span></tt> 権限を使用しそのセクションを保護することができます。この権限は、どこでも定義することができます。これからだって使うことができます。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">すべての権限は、Symfony2 によって管理されるため、<tt class="docutils literal"><span class="pre">ROLE_</span></tt> 接頭辞から始めなければなりません。より高度な <tt class="docutils literal"><span class="pre">Role</span></tt> 専用のクラスを定義する際には、<tt class="docutils literal"><span class="pre">ROLE_</span></tt> 接頭辞は使用しないでください。</p>
</div>
<div class="section" id="id17">
<h3>階層的な権限<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>ユーザにたくさんの権限を結びつける代わりに、権限の階層を作成し、権限の継承ルールを定義することができます:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">role_hierarchy</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">ROLE_ADMIN</span><span class="p-Indicator">:</span>       <span class="l-Scalar-Plain">ROLE_USER</span>
        <span class="l-Scalar-Plain">ROLE_SUPER_ADMIN</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">ROLE_ADMIN</span><span class="p-Indicator">,</span> <span class="nv">ROLE_ALLOWED_TO_SWITCH</span><span class="p-Indicator">]</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/security.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;role-hierarchy&gt;</span>
        <span class="nt">&lt;role</span> <span class="na">id=</span><span class="s">&quot;ROLE_ADMIN&quot;</span><span class="nt">&gt;</span>ROLE_USER<span class="nt">&lt;/role&gt;</span>
        <span class="nt">&lt;role</span> <span class="na">id=</span><span class="s">&quot;ROLE_SUPER_ADMIN&quot;</span><span class="nt">&gt;</span>ROLE_ADMIN, ROLE_ALLOWED_TO_SWITCH<span class="nt">&lt;/role&gt;</span>
    <span class="nt">&lt;/role-hierarchy&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;role_hierarchy&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;ROLE_ADMIN&#39;</span>       <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_USER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ROLE_SUPER_ADMIN&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">,</span> <span class="s1">&#39;ROLE_ALLOWED_TO_SWITCH&#39;</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>上記の設定では、<tt class="docutils literal"><span class="pre">ROLE_ADMIN</span></tt> 権限を持つユーザは、<tt class="docutils literal"><span class="pre">ROLE_USER</span></tt> 権限をも持つことになります。<tt class="docutils literal"><span class="pre">ROLE_SUPER_ADMIN</span></tt> 権限は、<tt class="docutils literal"><span class="pre">ROLE_ADMIN</span></tt>,<tt class="docutils literal"><span class="pre">ROLE_ALLOWED_TO_SWITCH</span></tt>, そして <tt class="docutils literal"><span class="pre">ROLE_USER</span></tt> を持つことになります。</p>
</div>
</div>
<div class="section" id="id18">
<h2>ログアウト<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<p>ほとんどの場合、ユーザにログアウトもできるようにさせたいでしょう。幸いにも、<tt class="docutils literal"><span class="pre">logout</span></tt> の設定値を有効化することにより、ファイアーウォールはログアウトを自動的に処理することができます:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">secured_area</span><span class="p-Indicator">:</span>
            <span class="c1"># ...</span>
            <span class="l-Scalar-Plain">logout</span><span class="p-Indicator">:</span>
                <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span>   <span class="l-Scalar-Plain">/logout</span>
                <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;firewall</span> <span class="na">name=</span><span class="s">&quot;secured_area&quot;</span> <span class="na">pattern=</span><span class="s">&quot;^/&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;logout</span> <span class="na">path=</span><span class="s">&quot;/logout&quot;</span> <span class="na">target=</span><span class="s">&quot;/&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/firewall&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;secured_area&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="c1">// ...</span>
            <span class="s1">&#39;logout&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/&#39;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="c1">// ...</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>ファイアーウォール内で上記のように設定すれば、ユーザを <tt class="docutils literal"><span class="pre">/logout</span></tt> (<tt class="docutils literal"><span class="pre">path</span></tt> で設定したルートの URL)に導くだけで、現在のユーザの認証を解除できます。<tt class="docutils literal"><span class="pre">path</span></tt> と <tt class="docutils literal"><span class="pre">target</span></tt> の設定値の両方のデフォルトはここで指定した値です。それらをカスタマイズする必要がない場合は、省略できるので、コンフィギュレーションを短くすることができます。</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">logout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;logout</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="s1">&#39;logout&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>ファイアーウォールが全ての面倒を見るため、<tt class="docutils literal"><span class="pre">/logout</span></tt> URL のコントローラを実装する<em>必要がない</em>ことを気に留めておいてください。しかし、その URL を生成するために使うルートを作成したいと思うかもしれません:</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Symfony 2.1 では、ログアウトのパスに対応するルートを指定する <em>必要があります</em> 。このルートが無ければ、ログアウトは機能しません。</p>
</div>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/routing.yml</span>
<span class="l-Scalar-Plain">logout</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">pattern</span><span class="p-Indicator">:</span>   <span class="l-Scalar-Plain">/logout</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/routing.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>

<span class="nt">&lt;routes</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/routing&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/routing http://symfony.com/schema/routing/routing-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;route</span> <span class="na">id=</span><span class="s">&quot;logout&quot;</span> <span class="na">pattern=</span><span class="s">&quot;/logout&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/routes&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/routing.php</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing\RouteCollection</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing\Route</span><span class="p">;</span>

<span class="nv">$collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RouteCollection</span><span class="p">();</span>
<span class="nv">$collection</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">()));</span>

<span class="k">return</span> <span class="nv">$collection</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>ユーザが一旦ログアウトすると、そのユーザは、上記の <tt class="docutils literal"><span class="pre">target</span></tt> の値によって定義されたパス(<tt class="docutils literal"><span class="pre">homepage</span></tt> など)にリダイレクトされます。ログアウトの設定に関する詳細は <a class="reference internal" href="../reference/configuration/security.html"><em>Security Configuration Reference</em></a> を参照してください。</p>
</div>
<div class="section" id="book-security-template">
<span id="id19"></span><h2>テンプレートにおけるアクセス制御<a class="headerlink" href="#book-security-template" title="Permalink to this headline">¶</a></h2>
<p>テンプレートの中で、現在のユーザが権限を持っているかを調べるには、ビルトインヘルパー関数を使用します:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Twig</em><div class="highlight-html+jinja"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">if</span> <span class="nv">is_granted</span><span class="o">(</span><span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="o">)</span> <span class="cp">%}</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>Delete<span class="nt">&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-html+php"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$view</span><span class="p">[</span><span class="s1">&#39;security&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">isGranted</span><span class="p">(</span><span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>Delete<span class="nt">&lt;/a&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ファイアーウォールが有効でない URL で、この関数を使用すると例外が投げられます。くどいようですが、この章で見られるように、全ての URL をカバーするメインのファイアーウォールはほとんど場合において、良いアイデアです。</p>
</div>
</div>
<div class="section" id="id20">
<h2>コントローラにおけるアクセス制御<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h2>
<p>コントローラから、現在のユーザが権限を持っているか調べるには、セキュリティコンテキストの <tt class="docutils literal"><span class="pre">isGranted</span></tt> メソッドを使用してください:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 管理者ユーザには異なる内容を表示します</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;security.context&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">isGranted</span><span class="p">(</span><span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// 管理者ユーザ用の内容のロードはここ</span>
    <span class="p">}</span>
    <span class="c1">// 正規の内容のロードはここ</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ファイアーウォールは有効になっている必要があります。そうでなければ、<tt class="docutils literal"><span class="pre">isGranted</span></tt> メソッドが呼ばれた際に例外が投げられます。詳細は、上記のテンプレートのセクションにおける Note を参照してください。</p>
</div>
</div>
<div class="section" id="id21">
<h2>他のユーザになりすます<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h2>
<p>ときどき、ログアウト、ログインを繰り返すこと無しに、あるユーザから他のユーザに切り替えることができると便利ですね。例えばデバッグをしている際や、特定のユーザのみ再現されるバグを理解する際などです。<tt class="docutils literal"><span class="pre">switch_user</span></tt> ファイアーウォールリスナーを有効化することによって簡単に実現することができます:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">main</span><span class="p-Indicator">:</span>
            <span class="c1"># ...</span>
            <span class="l-Scalar-Plain">switch_user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/security.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;firewall&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;switch-user</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/firewall&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;main&#39;</span><span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="c1">// ...</span>
            <span class="s1">&#39;switch_user&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>他のユーザに切り替えるには、現在の URL に <tt class="docutils literal"><span class="pre">_switch_user</span></tt> パラメータをクエリー文字列に加えて、ユーザ名をその値に加えるだけです:</p>
<blockquote>
<div><a class="reference external" href="http://example.com/somewhere?_switch_user=thomas">http://example.com/somewhere?_switch_user=thomas</a></div></blockquote>
<p>元のユーザに戻りたいときは、特別なユーザ名 <tt class="docutils literal"><span class="pre">exit</span></tt> を使用します:</p>
<blockquote>
<div><a class="reference external" href="http://example.com/somewhere?_switch_user=_exit">http://example.com/somewhere?_switch_user=_exit</a></div></blockquote>
<p>もちろん、この機能は特定の小さなユーザグループに利用可能とさせる必要があります。デフォルトでは、<tt class="docutils literal"><span class="pre">ROLE_ALLOWED_TO_SWITCH</span></tt> 権限を持つユーザのみがアクセス可能です。権限の名前は、<tt class="docutils literal"><span class="pre">role</span></tt> のセッティングから変更することができます。追加のセキュリティ対策として、<tt class="docutils literal"><span class="pre">parameter</span></tt> セッティングからクエリーパラメータを変更することもできます:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">main</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">// ...</span>
            <span class="l-Scalar-Plain">switch_user</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">role</span><span class="p-Indicator">:</span> <span class="nv">ROLE_ADMIN</span><span class="p-Indicator">,</span> <span class="nv">parameter</span><span class="p-Indicator">:</span> <span class="nv">_want_to_be_this_user</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/security.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;firewall&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;switch-user</span> <span class="na">role=</span><span class="s">&quot;ROLE_ADMIN&quot;</span> <span class="na">parameter=</span><span class="s">&quot;_want_to_be_this_user&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/firewall&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;main&#39;</span><span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="c1">// ...</span>
            <span class="s1">&#39;switch_user&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_ADMIN&#39;</span><span class="p">,</span> <span class="s1">&#39;parameter&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;_want_to_be_this_user&#39;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="id22">
<h2>ステートレス認証<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h2>
<p>デフォルトでは、Symfony2 は、ユーザのセキュリティコンテキストを持続するためにクッキー(セッション)を使用します。しかし、証明書や HTTP 認証を使用する際には、毎回のリクエストで証明書が利用可能なため、持続する必要ありません。こういったケースでは、リクエスト以外何も保存する必要がなければ、ステートレス認証を有効化することができます。つまり、Symfony2 によってクッキーは作られません:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/security.yml</span>
<span class="l-Scalar-Plain">security</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">firewalls</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">main</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">http_basic</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
            <span class="l-Scalar-Plain">stateless</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/security.xml --&gt;</span>
<span class="nt">&lt;config&gt;</span>
    <span class="nt">&lt;firewall</span> <span class="na">stateless=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;http-basic</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/firewall&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;main&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;http_basic&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(),</span> <span class="s1">&#39;stateless&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">フォームログインを使用する際には、 <tt class="docutils literal"><span class="pre">stateless</span></tt> を <tt class="docutils literal"><span class="pre">true</span></tt> に指定していても、Symfony2 はクッキーを作成します。</p>
</div>
</div>
<div class="section" id="id23">
<h2>最後に<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h2>
<p>セキュリティ機能は、あなたのアプリケーションの深く複雑な問題を正しく解決してくれます。幸いにも、Symfony のセキュリティコンポーネントは、<em>認証</em>と<em>承認</em>をベースにした実績のあるセキュリティモデルに沿っています。認証は、常に最初に起こり、HTTP 認証やログインフォームなどのいくつもの異なる方法を通して、ユーザの同一性を判断するファイアーウォールによって処理されます。クックブックでは、&#8221;remember me&#8221;クッキー機能の実装方法を含め、他の方法で認証処理を実装したサンプルを見つけることができます。</p>
<p>ユーザがいったん認証されれば、認証の層は、ユーザが特定のリソースへのアクセス権を保持しているか判断することができます。ほとんどの場合において、<em>権限</em>は URL、クラス、メソッドに適用され、ユーザに権限が無い際には、アクセスが拒否されます。しかし、認証レイヤーはもっと深く考えられており、ユーザが与えられたリソースにアクセスできるかどうかを、複数の関係者が判断できるといったような &#8220;voting&#8221; のシステムに沿っています。このことに関するトピックの詳細は、クックブックを参照してください。</p>
</div>
<div class="section" id="id24">
<h2>クックブック でもっと学ぶ<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="../cookbook/security/force_https.html"><em>Forcing HTTP/HTTPS</em></a></li>
<li><a class="reference internal" href="../cookbook/security/voters.html"><em>Blacklist users by IP address with a custom voter</em></a></li>
<li><a class="reference internal" href="../cookbook/security/acl.html"><em>Access Control Lists (ACLs)</em></a></li>
<li><a class="reference internal" href="../cookbook/security/remember_me.html"><em>&#8220;Remember Me&#8221; ログイン機能の追加方法</em></a></li>
</ul>
</div>
</div>


<div id="page_prev_next">
<a class="prev" href="forms.html">< フォーム</a>
<a class="next" href="http_cache.html">HTTP キャッシュ ></a>
</div>

<div class="common_content_footer">
<ul>
  <li> → <a href="http://symfony.com/doc/current/book/security.html">公式英語ドキュメント</a></li>
  <li> → <a href="https://github.com/symfony/symfony-docs/commits/master/book/security.rst">原文コミット履歴</a>
  <li> → <a href="https://github.com/symfony-japan/symfony-docs-ja/commits/master/book/security.rst">翻訳コミット履歴</a>
</ul>
<br />
翻訳の不備などは、お気軽にコメント欄にてご指摘ください。
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'symfony-japan'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = 'unique_dynamic_id_1234';
    // var disqus_url = 'http://example.com/permalink-to-page.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="fb-like-box" data-href="http://www.facebook.com/symfonyjapan" data-width="203" data-show-faces="true" data-stream="true" data-border-color="#FFF" data-header="true"></div>

          </div>
        </div>
      </div>

      <div class="clearer"></div>
    </div>

      </div>
      <!-- end #main -->
    </div>
    <!-- end #content_wrapper -->
  </div>
  <!-- end #content -->


  <div id="footer">
    <div id="footer_wrapper">
      <div id="footer_content">
        <div style=" position: relative;">
          <div id="footer_left"></div>
          <div id="footer_right"></div>
        </div>
        <div id="f_navbar">
        <ul>
          <li><a href="../index.html">トップ（索引）</a></li>
          <li><a href="../quick_tour/index.html">クイックツアー</a></li>
          <li><a href="index.html">ガイドブック</a></li>
          <li><a href="../cookbook/index.html">クックブック</a></li>
          <li><a href="../components/index.html">コンポーネント</a></li>
          <li><a href="../reference/index.html">リファレンス</a></li>
          <li><a href="../contributing/index.html">貢献</a></li>
        </ul>
      </div>
      <!-- end #navbar -->
        <div>
          <p id="copyright">
            <a href="../contributing/documentation/license.html">ドキュメントの著作権</a>は Symfony 公式に準じます(Creative Commons Attribution-Share Alike 3.0 Unported ライセンス)。<br />
            Copyright &copy; 2014 Symfony Japan. All rights reserved.<br />
            &nbsp;&nbsp;&nbsp;Bandwidth and hardware provided by <a href="http://www.asial.co.jp/">アシアル株式会社</a>
            &nbsp;&nbsp;Powered by <a href="http://sphinx.pocoo.org/">Sphinx</a>
          </p>
        </div>
      </div>
      <!-- end #footer_content -->
        </div>
        <!-- end #footer_wrapper -->
      </div>
      <!-- end #footer -->
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-16659283-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
  </body>
</html>
